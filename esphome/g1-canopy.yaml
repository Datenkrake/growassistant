esp32:
  board: esp32-c3-devkitm-1
  framework:
    type: arduino

# Enable Home Assistant API
# api:
#   encryption:
#     key: "w3Ll55YCHSdu8tj12EAq5Xr72upLPtEXSTI5jckiibE="

ota:
  - platform: esphome
    password: "552ee6f911d97dd2644ae7f53f972e15"

esphome:
  name: g1-canopy

####################################################################
# configure substitutions and friendly name
####################################################################

  area: ${area_id}
  friendly_name: ${area_id}_${device_id}${suffix}

# Note for pinout on ESP32-C3 Supermini:
# Pin Functions
# GPIO0 / A0 (bottom right corner in top view with USB port on the top)
# GPIO1 / A1
# GPIO2 / A2 (external pull-up resistor and is a boot related pin)
# GPIO3 / A3
# GPIO4 / A4 / SCK
# GPIO5 / A5 / MISO
# GPIO6 / MOSI
# GPIO7 / SS
# GPIO8 / SDA
# GPIO9 / SCL (external pull-down resistor and is a boot related pin "BOOT button")
# GPIO10
# GPIO20 / RX
# GPIO21 / TX

substitutions:
  area_id: G1
  device_id: "CANOPY"
  suffix: ""
  pin_sda: GPIO7
  pin_scl: GPIO6
  pin_echo: GPIO2
  pin_trigger: GPIO1
  address_bme680: "0x76"
  address_bh1750: "0x23"
  bme680_temp_offset: "2.5"

####################################################################
# generic yaml for humidifiers below
####################################################################
logger:
captive_portal:
wifi:
  !include includes/wifi_default.yaml

globals:
  - id: ${area_id}_${device_id}${suffix}_door_open
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: ${area_id}_${device_id}${suffix}_new_brightness_global
    type: float
    restore_value: no
    initial_value: '0.0'

mqtt:
  broker: !secret mqtt_broker
  username: !secret mqtt_username
  password: !secret mqtt_password
  topic_prefix: "auto/${area_id}/${device_id}"
  log_topic: "debug/${area_id}/${device_id}"
  on_message:
    - topic: ${area_id}/door_switch/#
      then:
        - lambda: |-
            if (strcmp(x.c_str(), "ON") == 0) {
              id(${area_id}_${device_id}${suffix}_door_open) = true;
            } else if (strcmp(x.c_str(), "OFF") == 0) {
              id(${area_id}_${device_id}${suffix}_door_open) = false;
            }
            id(adjust_brightness).execute();

time:
  - !include includes/time_mqtt.yaml
i2c:
  !include includes/i2c_bus_a.yaml
bme68x_bsec2_i2c:
  !include includes/bme680x_bsec2_i2c.yaml
text_sensor:
  - !include includes/text_sensor_mqtt_full_spectrum_brightness_json.yaml

sensor:
  # PHYSICAL SENSORS
  ## LUX
  - !include includes/sensor_bh1750.yaml
  ## ULTRASONIC
  - !include includes/sensor_cola_ultrasonic.yaml
  ## TEMPERATURE, HUMIDITY
  - !include includes/sensor_bme68x_bsec2.yaml
  # CALCULATED SENSORS
  ## SCHEDULE
  - !include includes/sensor_sunrise_time_hours.yaml
  ## CLIMATE
  - !include includes/sensor_vpd.yaml
  - !include includes/sensor_rh_target.yaml
  - !include includes/sensor_dew_point.yaml
  ## LIGHT INTENSITY
  - !include includes/sensor_ppfd.yaml
  - !include includes/sensor_ppfd_target.yaml
  - !include includes/sensor_dli.yaml
  - !include includes/sensor_dli_target.yaml
  - !include includes/sensor_growth_cycle.yaml
  - !include includes/sensor_day_length.yaml
  # MQTT
  - !include includes/sensor_mqtt_full_spectrum_brightness.yaml

binary_sensor:
  # LIGHT SWITCH
  - !include includes/binary_sensor_day_phase_target.yaml

number:
  # USER INPUTS
  ## SCHEDULING
  - !include includes/number_start_date.yaml
  - !include includes/number_sunrise_time.yaml
  - !include includes/number_day_length_vegetative.yaml
  - !include includes/number_day_length_generative.yaml
  ## CYCLE DURATIONS
  - !include includes/number_duration_vegetative.yaml
  - !include includes/number_duration_flipping.yaml
  - !include includes/number_duration_generative.yaml
  - !include includes/number_duration_drying.yaml
  ## LIGHT INTENSITY CONFIG
  - !include includes/number_dli_vegetative_start.yaml
  - !include includes/number_dli_vegetative_end.yaml
  - !include includes/number_dli_generative_start.yaml
  - !include includes/number_dli_generative_peak.yaml
  - !include includes/number_dli_generative_end.yaml
  ## CLIMATE CONTROLS
  - !include includes/number_temperature_max.yaml
  - !include includes/number_vpd_target.yaml
  - !include includes/number_leaf_offset.yaml
  ## SENSOR THINGIES
  - !include includes/number_illuminance_calibration_factor.yaml
  - !include includes/number_door_open_brightness.yaml
  - !include includes/number_cola_distance_threshold.yaml
  - !include includes/number_schedule_day_hours.yaml
  - !include includes/number_schedule_day_hours_total.yaml
  
interval:
  - interval: 300s  # Adjust as needed
    then:
      - script.execute: check_cola_distance

  - interval: 30s
    then:
      - script.execute: adjust_brightness_shelly_dimmer

script:
  - !include includes/script_check_cola_distance.yaml
  - !include includes/script_mqtt_publish_cola_detected_true.yaml
  - !include includes/script_mqtt_publish_cola_detected_false.yaml
  - !include includes/script_adjust_brightness_shelly_dimmer.yaml
