blueprint:
  name: Water Circulation Control Blueprint
  description: Controls the water circulation pump based on the circulation period and duration.
  domain: automation
  input:
    global_enable:
      name: Global Enable
      selector:
        entity:
          domain: input_boolean

    irrigation_enable:
      name: Irrigation Enable
      selector:
        entity:
          domain: input_boolean

    service_mode:
      name: Service Mode
      selector:
        entity:
          domain: input_boolean

    water_circulation_period:
      name: Water Circulation Period
      selector:
        entity:
          domain: input_number

    water_circulation_duration:
      name: Water Circulation Duration
      selector:
        entity:
          domain: input_number

    circulation_pump:
      name: Circulation Pump
      description: Specify the entity of the circulation pump
      selector:
        entity:
          domain: switch

trigger:
  - platform: time_pattern
    minutes: "/1"

condition:
  - condition: template
    value_template: >
      {{ (now().timestamp() // 60) % (states('!input water_circulation_period') | int) == 0 }}
  - condition: state
    entity_id: !input global_enable
    state: 'on'
  - condition: state
    entity_id: !input irrigation_enable
    state: 'on'
  - condition: state
    entity_id: !input service_mode
    state: 'off'

action:
  - service: switch.turn_on
    target:
      entity_id: !input circulation_pump

  - delay: "{{ states('!input water_circulation_duration') | int * 60 }}"

  - service: switch.turn_off
    target:
      entity_id: !input circulation_pump
